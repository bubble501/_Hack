最近在工作中遇到了一个“诡异”的问题。所谓“诡异”是因为它的现象“挑战”了你对所有常识的认知，按照你习惯了的经验，一定会首先想到“我操，这怎么可能？！”

最终经过一系列周折，将这个问题的原因弄出来了，所以感觉这个排查有很多值得思考、反思的地方，很值得自己时刻回顾：

* 你平时积累的所谓经验在遇到问题的时候是帮助你快速定位还是可能禁锢你的思维
* 面对一个不符合你“常识”的问题，该怎么排查，重点是如何突破自己的思维定式

## 诡异的现象

生产环境上出现了问题，需要开发来排查。很简单，把日志拿来嘛

操，见鬼了，怎么只有一部分日志？和问题相关的日志怎么都没了？！只剩下部分日志（很明显，和自己的常识、经验完全不符，因为正常的思维都是默认日志是绝对会输出的）

既然日志丢失了，不符合常识和经验了，那么就先去合理猜测是什么原因导致的？

* 压缩日志是专门的线程干的，是不是这个线程出问题了？
* 是不是有其他的程序干扰，导致日志线程没办法写文件？

查看客户发过来的日志，连续多天都是这个现象，如果是每天日志输出线程都有问题，其概率太小，而且为什么还是有部分日志会输出出来呢

第二种的概率还可能挺高，而且和同事讨论，他在之前还真的排查过这类似的问题

另外收集到的信息就是客户将转换机任务维护成按时间段运行，每天在08:50—15:40 19:48—23:50这两个时间段会自动运行，当然监控模式下依然可以手动开关转换机任务的

再去仔细看，发现任务日志每天都有丢失的情况，而框架日志从来没有丢过，这时候开始将怀疑点转向任务本身的逻辑

## 分析有没有其他可能

按照自己平时排查问题的经验，从现有的数据中找规律是一个很好的方法，那先就现有的日志找一下规律

首先是去从大量的日志中找出有代表性的数据：

* 选择金交所竞价任务，查看05-22、05-23、05-24的日志，查看每个日志文件的开始时间和结束时间
* 查看金交所竞价任务在框架上输出的关键信息：开启时间、关闭时间；因为和日志有关，所以同样挑出日志压缩的时间
* 注意任务日志中输出的是当前机器时间；框架日志输出的是后台数据库时间，可能存在时间差

**附录**中是从05-22、05-23、05-24剩余的日志中摘出来的部分关键日志

仔细分析发现任务日志文件中有些日志是完整的，比如2017-05-24的ResourceMgr日志等，但更多的任务日志是丢失内容的！

比如2017-05-24，丢失数据的任务日志，大部分都是丢失了19:49:23（当前机器时间）之前的数据

再去对比这个时间点左右的框架日志，考虑到任务的机器时间和框架的后台时间误差

```
19:48:03 竞价任务启动
19:48:06:<金交所竞价交易统一报盘>开始压缩日志文件
19:48:16:<金交所竞价交易统一报盘>压缩文件完成
```

这个时间点就是在做日志压缩的事情

再去看2017-05-23、2017-05-24的日志，都是一样的，丢失数据的点正好和日志压缩的时间点对应！

所以怀疑是因为日志压缩导致的

## 再去挑战常识

为什么会和日志压缩有关呢？为什么沪深直连等我接触过的大部分直连任务都没有问题呢？

细想一下我之前接触的直连任务都是现货直连任务，没有夜盘的概念，但是金交所报盘有夜盘的概念，在物理日期存在交易日期切换的情况，比如当前的物理日期是2017-05-24，在物理时间9点之前，交易所的交易日期是2017-05-24，但是等到晚上大概9点的时候，交易日期切换到了2017-05-25

所以普通现货直连的业务日期就等于转换机机器日期；而金交所报盘的业务日志可能不等于机器日期

而我传给日志压缩函数的参数就有一个时间字段，我在金交所任务中传的时间并不是当前的机器时间而是业务日期，仔细看日志压缩实现的代码，其会判断传入的日期（业务日期）和文件的修改日期（也就是机器日期），然后会有文件压缩等的操作（详细逻辑不在这里说明了，并不是本次排查的重点），经过自己模拟这种场景测试，发现确实会导致日志文件的丢失！

至此，问题查清楚了，就是因为调用日志压缩方法的时候，传入的日期不正确导致的！

## 关于数据分析的思考

其实这里面就是简单的数据分析来解决问题的应用。但是所有这些工作都是自己手动完成的

能不能将这个过程自动化，编程去摘取日志中需要的数据，编程去找出数据中的规律？

这样才更有意思！

## 附录：剩余日志中摘出来的部分关键日志

**2017-05-24**

```
框架日志
	08:28:41 框架启动
	08:28:42 竞价任务启动
	08:50:04:<金交所竞价交易统一报盘>开始压缩日志文件
	08:50:18:<金交所竞价交易统一报盘>压缩文件完成
	15:40:02 竞价任务停止
	19:48:03 竞价任务启动
	19:48:06:<金交所竞价交易统一报盘>开始压缩日志文件
	19:48:16:<金交所竞价交易统一报盘>压缩文件完成
	20:05:30 竞价任务停止
	20:05:30 框架关闭
	20:08:43 框架启动
	20:08:48:<金交所竞价交易统一报盘>开始压缩日志文件
	20:08:52:<金交所竞价交易统一报盘>压缩文件完成
	20:08:44 竞价任务启动
ResourceMgr
	08:51:23 ~ 20:06:45
UniGemsTrade
	19:49:23
UniGemsTrade_Entrust
	19:49:24
UniGemsTrade_GemsRecv
	19:49:24 ~ 20:06:45
UniGemsTrade_GemsSend
	19:49:23 ~ 20:06:45
UniGemsTrade_Quotation
	19:49:24 ~ 20:06:45
UniGemsTrade_TimedRefresh
	19:49:24 ~ 20:00:59
下行日志丢失
```

**2017-05-23**

```
框架日志
	00:20:59 框架启动
	00:21:12 竞价任务启动
	00:21:12 竞价任务结束
	00:21:12 竞价任务启动
	00:21:12:<金交所竞价交易统一报盘>开始压缩日志文件
	00:21:15:<金交所竞价交易统一报盘>压缩文件完成
	...
	00:21:38:<金交所竞价交易统一报盘>开始压缩日志文件
	00:21:39:<金交所竞价交易统一报盘>压缩文件完成
	00:21:49:<金交所竞价交易统一报盘>开始压缩日志文件
	00:21:49:<金交所竞价交易统一报盘>压缩文件完成
	00:24:28 框架关闭
	01:15:23 框架启动
	01:15:33 竞价任务启动
	01:15:33:<金交所竞价交易统一报盘>开始压缩日志文件
	01:15:33:<金交所竞价交易统一报盘>压缩文件完成
	01:16:45 竞价任务关闭
	01:16:55 框架关闭
	08:28:41 框架启动
	08:34:06 竞价任务启动
	08:50:04:<金交所竞价交易统一报盘>开始压缩日志文件
	08:50:04:<金交所竞价交易统一报盘>压缩文件完成
	15:40:03 竞价任务结束
	18:20:45 框架关闭
	18:21:00 框架启动
	19:48:04 竞价任务启动
	19:48:05:<金交所竞价交易统一报盘>开始压缩日志文件
	19:48:15:<金交所竞价交易统一报盘>压缩文件完成
	23:50:01 竞价任务结束
	23:50:07 框架关闭
ResourceMgr
	00:22:31 ~ 23:51:20
UniGemsTrade
	19:49:24
UniGemsTrade_Entrust
	19:49:24
UniGemsTrade_GemsRecv
	19:49:24 ~ 23:51:19
UniGemsTrade_GemsSend
	19:49:24 ~ 23:51:20
UniGemsTrade_Quotation
	19:49:24 ~ 23:51:19
UniGemsTrade_TimedRefresh
	19:49:24 ~ 23:49:27
UniGemsTrade_SYS
	00:22:19 ~ 23:51:20
下行日志
	15:01:48 ~ 21:04:29	
	21:04:29 ~ 22:57:37
	22:57:37 ~ 23:51:20
```

**2017-05-22**

```
框架日志
	08:28:42 框架启动
	08:50:03 竞价任务启动
	08:50:04:<金交所竞价交易统一报盘>开始压缩日志文件
	08:50:17:<金交所竞价交易统一报盘>压缩文件完成
	10:09:46 竞价任务结束
	10:10:59 竞价任务启动
	10:10:59:<金交所竞价交易统一报盘>开始压缩日志文件
	10:10:59:<金交所竞价交易统一报盘>压缩文件完成
	15:40:03 竞价任务结束
	19:48:02 竞价任务启动
	19:48:05:<金交所竞价交易统一报盘>开始压缩日志文件
	19:48:16:<金交所竞价交易统一报盘>压缩文件完成
	23:21:10 竞价任务结束
	23:21:10 框架关闭
	23:21:32 框架启动
	23:21:37 竞价任务启动
	23:21:38:<金交所竞价交易统一报盘>开始压缩日志文件
	23:21:44:<金交所竞价交易统一报盘>压缩文件完成
	23:50:01 竞价任务结束
	23:50:08 框架关闭
ResourceMgr
	23:22:57 ~ 23:51:20
UniGemsTrade
	23:22:57
UniGemsTrade_Entrust
	23:22:58
UniGemsTrade_GemsRecv
	23:22:57 ~ 23:51:20
UniGemsTrade_GemsSend
	23:22:57 ~ 23:51:20
UniGemsTrade_Quotation
	23:22:58 ~ 23:51:20
UniGemsTrade_TimedRefresh
	23:22:58 ~ 23:42:58
UniGemsTrade_SYS
	08:30:02 ~ 23:51:20
下行日志
	21:30:29 ~ 23:28:57
	23:28:57 ~ 23:51:20
```

